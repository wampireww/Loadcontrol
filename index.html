<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Harekat Load Control - Final</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* Temel gözü yormayan CSS, font ve input boyutları korunuyor */
body {
    font-family: Arial, sans-serif;
    background: #f0f2f5;
    margin: 5px;
}
section {
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 8px;
    margin-bottom: 8px;
}
h1 {
    text-align: center;
    color: #004080;
    font-weight: normal;
    margin: 5px;
    font-size: 1.4em;
}
h3 {
    cursor: pointer;
    margin: 4px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.flex {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 5px;
}
input[type=number], input[type=text] {
    width: 60px;
}
button {
    background: #004080;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 2px 6px;
    cursor: pointer;
}
button:hover {
    background: #0066cc;
}
.compartment {
    border-top: 1px solid #aaa;
    margin-top: 5px;
    padding-top: 5px;
}
.content {
    display: none;
    background: #fafafa;
    padding: 4px;
    border-radius: 4px;
}
.bagaj, .konteyner, .kargo, .ek {
    border: 1px dashed #aaa;
    padding: 4px;
    margin: 3px 0;
    border-radius: 4px;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}
.summary {
    background: #e6f0ff;
    padding: 5px;
}
.item-wrapper {
    display: inline-flex;
    flex-wrap: wrap;
    align-items: center;
    margin: 2px 5px 5px 0;
}
.item-input {
    width: 60px;
    margin-left: 5px;
}
.weight-display {
    font-size: .9em;
    color: #004080;
    margin-left: 10px;
}
.midBadge {
    font-size: .78em;
    color: #444;
    margin: 0 10px;
}
textarea {
    width: 100%;
    height: 80px;
    margin-top: 5px;
}
</style>
</head>
<body>
<h1>Harekat Load Control</h1>

<section class="flex">
<div style="flex:1">
Uçak
<select id="aircraft" onchange="saveAircraft(); updateCompartments(true);">
<option value="">Seç</option>
<option>A319</option><option>A320</option><option>A321</option><option>B737</option>
<option>A330</option><option>A350</option><option>B777</option><option>B787</option>
</select>
</div>
<div style="flex:1">
Yükleme
<select id="loadType" onchange="saveLoadType(); updateCompartments(true);">
<option value="">Seçiniz</option>
<option value="YIGMA">Yığma</option>
<option value="ULD">ULD</option>
</select>
</div>
</section>

<section class="flex">
Water <input type="text" id="waterInput" oninput="autoSave(); updateSummary()">
Pantry <input type="text" id="pantryInput" oninput="autoSave(); updateSummary()">
</section>

<section>
<h3>Bagaj Ortalamaları</h3>
<div class="flex">
By <input type="number" id="byAvg" oninput="updateMix()">
Bc <input type="number" id="bcAvg" oninput="updateMix()">
Mix <input type="number" id="mxAvg" readonly>
</div>
</section>

<section><div id="compartments"></div></section>

<section class="summary">
<h3>Final Kontrol</h3>
<div id="summary"></div>
<div class="flex" style="margin-top:6px;font-weight:bold">
<span>Water: <span id="finalWater">Nil</span></span>
<span>Pantry: <span id="finalPantry">Nil</span></span>
</div>
<div class="flex" style="justify-content:flex-end;gap:10px;margin-top:5px">
<button onclick="updateSummary()">Güncelle</button>
<button onclick="saveManual()">Kaydet</button>
</div>
<textarea id="note" placeholder="Not ekle" oninput="autoSave()"></textarea>
</section>

<script>
/* ---- Ayarlar ve Kompartman Tanımları ---- */
const comps={A319:[1,4,5],A320:[1,3,4,5],A321:[1,2,3,4,5],B737:[1,2,3,4],
A330:[1,2,3,4,5],A350:[1,2,3,4,5],B777:[1,2,3,4,5],B787:[1,2,3,4,5]};
const wide=["A330","A350","B777","B787"];

/* ---- Sayfa Yenilenmesini Engelle ---- */
document.addEventListener('touchmove', function(e){if(e.scale !== 1) e.preventDefault();},{passive:false});
document.addEventListener('gesturestart', function(e){e.preventDefault();},{passive:false});

/* ---- AutoSave ve LocalStorage ---- */
function autoSave(){localStorage.setItem("hlc",document.body.innerHTML);}
function saveAircraft(){localStorage.setItem("aircraft",aircraft.value);}
function saveLoadType(){localStorage.setItem("loadType",loadType.value);}

/* ---- Mix Hesaplama ---- */
function updateMix(){
  mxAvg.value=((+byAvg.value||0)+(+bcAvg.value||0))/2;
  autoSave();updateSummary();
}

/* ---- Kompartmanları ve İçeriği Güncelle ---- */
function updateCompartments(reset){
  if(reset) compartments.innerHTML="";
  if(!aircraft.value || !loadType.value) return;
  comps[aircraft.value].forEach(n=>{
    const c=document.createElement("div");
    c.className="compartment";
    c.innerHTML=`<h3 onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display=='none'?'block':'none'">
    CPT ${n}<span class="weight-display">0 kg</span></h3><div class="content"></div>`;
    const ct=c.querySelector(".content");
    
    if(loadType.value==="YIGMA"||n===5){
      ct.innerHTML+=`<div class="bagaj flex">
      By <input type="number" class="by" oninput="autoSave();updateSummary()">
      Bc <input type="number" class="bc" oninput="autoSave();updateSummary()">
      Mix <input type="number" class="mx" oninput="autoSave();updateSummary()">
      </div>`;
    }
    
    if(loadType.value==="ULD" && n!==5){
      const lbl=wide.includes(aircraft.value)?"AKE":"AKH";
      ct.innerHTML+=`<div class="konteyner flex">${lbl} Bagaj
        <select class="bagType"><option>By</option><option>Bc</option><option>Mix</option></select>
        <button onclick="addBagaj(this)">+</button>
      </div>`;
    }
    
    ct.innerHTML+=`<div class="kargo flex">Cargo <button onclick="addItem(this,'Cargo')">+</button></div>
    <div class="ek flex">Manuel <button onclick="addItem(this,'Manuel')">+</button></div>`;
    compartments.appendChild(c);
  });
  updateSummary();
  autoSave();
}

/* ---- Ekleme ve Silme ---- */
function addBagaj(b){
  const t=b.previousElementSibling.value,p=b.parentElement;
  const d=document.createElement("div");
  d.className="konteyner-item item-wrapper"; d.dataset.type=t;
  const s=document.createElement('span'); s.textContent=t; d.appendChild(s);
  const input=document.createElement('input'); input.type="number"; input.className="item-input";
  input.oninput=function(){autoSave();updateSummary()};
  d.appendChild(input);
  const btn=document.createElement('button'); btn.textContent="Sil";
  btn.onclick=function(){d.remove(); updateSummary(); autoSave();};
  d.appendChild(btn);
  p.appendChild(d);
}

function addItem(b,k){
  const p=b.parentElement;
  const d=document.createElement("div");
  d.className="item-wrapper"; d.dataset.kind=k;
  const s=document.createElement('span'); s.textContent=k; d.appendChild(s);
  const input=document.createElement('input'); input.type="number"; input.className="item-input";
  input.oninput=function(){updateSummary();autoSave()};
  d.appendChild(input);
  const btn=document.createElement('button'); btn.textContent="Sil";
  btn.onclick=function(){d.remove(); updateSummary(); autoSave();};
  d.appendChild(btn);
  p.appendChild(d);
}

/* ---- Badge Güncelleme (Mn / B / C) ---- */
function updateCPTBadge(){
  document.querySelectorAll('.compartment').forEach(c=>{
    const loadTypeVal=loadType.value;
    const isULD=loadTypeVal==='ULD';
    const isYIGMA=loadTypeVal==='YIGMA';
    let Btotal=0, Ctotal=0, Mtotal=0;
    const compNum = parseInt(c.querySelector('h3').childNodes[0].nodeValue.trim().split(" ")[1]);
    
    // Bagaj
    if(isYIGMA){
      c.querySelectorAll('.bagaj input').forEach(inp=>Btotal+=+inp.value||0);
    } else if(isULD){
      if(compNum===5){
        c.querySelectorAll('.bagaj input').forEach(inp=>Btotal+=+inp.value||0);
      } else {
        Btotal=c.querySelectorAll('.konteyner-item').length;
      }
    }
    
    // Kargo
    if(isYIGMA){
      c.querySelectorAll('.item-wrapper[data-kind="Cargo"]').forEach(i=>Ctotal+=+i.querySelector('input').value||0);
    } else if(isULD){
      Ctotal=0;
      c.querySelectorAll('.item-wrapper[data-kind="Cargo"]').forEach(i=>Ctotal+=+i.querySelector('input').value||0);
    }
    
    // Manuel
    if(isYIGMA){
      c.querySelectorAll('.item-wrapper[data-kind="Manuel"]').forEach(i=>Mtotal+=+i.querySelector('input').value||0);
    } else if(isULD){
      Mtotal=0;
      c.querySelectorAll('.item-wrapper[data-kind="Manuel"]').forEach(i=>Mtotal+=+i.querySelector('input').value||0);
    }
    
    const h=c.querySelector('h3');
    let mid=h.querySelector('.midBadge');
    if(!mid){mid=document.createElement('span'); mid.className='midBadge'; h.insertBefore(mid,h.querySelector('.weight-display'));}
    let out=[];
    if(Btotal) out.push("B "+Btotal);
    if(Ctotal) out.push("C "+Ctotal);
    if(Mtotal) out.push("M"+"n "+Mtotal); // Mn
    mid.textContent=out.join(" / ");
  });
}

/* ---- Summary Hesaplama ---- */
function updateSummary(){
  let out="";
  const byA=+byAvg.value||0, bcA=+bcAvg.value||0, mxA=+mxAvg.value||0;
  document.querySelectorAll(".compartment").forEach(c=>{
    let t=0;
    c.querySelectorAll(".bagaj").forEach(b=>{
      t+=(+b.querySelector(".by").value||0)*byA;
      t+=(+b.querySelector(".bc").value||0)*bcA;
      t+=(+b.querySelector(".mx").value||0)*mxA;
    });
    c.querySelectorAll(".konteyner-item").forEach(k=>{
      const a=+k.querySelector("input").value||0;
      const avg=k.dataset.type==="By"?byA:k.dataset.type==="Bc"?bcA:mxA;
      t+=(a*avg+70)-a;
    });
    c.querySelectorAll('.item-wrapper').forEach(i=>t+=+i.querySelector("input").value||0);
    c.querySelector(".weight-display").textContent=Math.round(t)+" kg";
    out+=`<div>${c.querySelector("h3").childNodes[0].nodeValue.trim()}: ${Math.round(t)} kg</div>`;
  });
  summary.innerHTML=out;
  finalWater.textContent=waterInput.value||"Nil";
  finalPantry.textContent=pantryInput.value||"Nil";
  updateCPTBadge();
}

/* ---- Manual Save ---- */
function saveManual(){autoSave();}

/* ---- Sayfa Yüklenince Storage'dan Bilgileri Geri Yükle ---- */
window.addEventListener('load', ()=>{
  if(localStorage.getItem("hlc")) document.body.innerHTML=localStorage.getItem("hlc");
  if(localStorage.getItem("aircraft")) aircraft.value=localStorage.getItem("aircraft");
  if(localStorage.getItem("loadType")) loadType.value=localStorage.getItem("loadType");
  updateCompartments(false);
  updateSummary();
});
</script>
</body>
</html>
