<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Harekat Load Control - Final</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* Android pull-to-refresh (aşağı çekip yenileme) özelliğini engeller */
html, body {
  overscroll-behavior-y: contain;
}

body{font-family:Arial,sans-serif;background:#f0f2f5;margin:5px;}
section{background:#fff;border:1px solid #ccc;border-radius:8px;padding:8px;margin-bottom:8px;}
h1{text-align:center;color:#004080;font-weight:normal;margin:5px;font-size:1.4em;}
h3{cursor:pointer;margin:4px 0;display:flex;justify-content:space-between;align-items:center;}
.flex{display:flex;flex-wrap:wrap;align-items:center;gap:5px;}
input[type=number],input[type=text]{width:60px;}
button{background:#004080;color:#fff;border:none;border-radius:4px;padding:2px 6px;cursor:pointer;}
button:hover{background:#0066cc;}
.compartment{border-top:1px solid #aaa;margin-top:5px;padding-top:5px;}
.content{display:none;background:#fafafa;padding:4px;border-radius:4px;}
.bagaj,.konteyner,.kargo,.ek{border:1px dashed #aaa;padding:4px;margin:3px 0;border-radius:4px;display:flex;flex-wrap:wrap;gap:5px;}
.summary{background:#e6f0ff;padding:5px;}
.item-wrapper{display:inline-flex;flex-wrap:wrap;align-items:center;margin:2px 5px 5px 0;}
.item-input{width:60px;margin-left:5px;}
.weight-display{font-size:.9em;color:#004080;margin-left:10px;}
.midBadge{font-size:.78em;color:#444;margin:0 10px}
textarea{width:100%;height:80px;margin-top:5px;}
</style>
</head>
<body>
<h1>Harekat Load Control</h1>

<section class="flex">
<div style="flex:1">Uçak
<select id="aircraft" onchange="fullReset();checkLoadType()">
<option value="">Seç</option>
<option>A319</option><option>A320</option><option>A321</option><option>B737</option>
<option>A330</option><option>A350</option><option>B777</option><option>B787</option>
</select></div>
<div style="flex:1">Yükleme
<select id="loadType" onchange="checkLoadType()">
<option value="">Seçiniz</option>
<option value="YIGMA">Yığma</option>
<option value="ULD">ULD</option>
</select></div>
</section>

<section class="flex">
Water <input type="text" id="waterInput" oninput="saveAll();updateSummary()">
Pantry <input type="text" id="pantryInput" oninput="saveAll();updateSummary()">
</section>

<section>
<h3>Bagaj Ortalamaları</h3>
<div class="flex">
By <input type="number" id="byAvg" oninput="updateMix()">
Bc <input type="number" id="bcAvg" oninput="updateMix()">
Mix <input type="number" id="mxAvg" readonly>
</div>
</section>

<section><div id="compartments"></div></section>

<section class="summary">
<h3>Final Kontrol</h3>
<div id="summary"></div>
<div class="flex" style="margin-top:6px;font-weight:bold">
<span>Water: <span id="finalWater">Nil</span></span>
<span>Pantry: <span id="finalPantry">Nil</span></span>
</div>
<div class="flex" style="justify-content:flex-end;gap:10px;margin-top:5px">
<button onclick="updateSummary()">Güncelle</button>
<button onclick="saveAll()">Kaydet</button>
<button onclick="clearStorage()" style="background:#cc0000">Sıfırla</button>
</div>
<textarea id="note" placeholder="Not ekle" oninput="saveAll()"></textarea>
</section>

<script>
const comps={A319:[1,4,5],A320:[1,3,4,5],A321:[1,2,3,4,5],B737:[1,2,3,4],
A330:[1,2,3,4,5],A350:[1,2,3,4,5],B777:[1,2,3,4,5],B787:[1,2,3,4,5]};
const wide=["A330","A350","B777","B787"];

function fullReset(){
  compartments.innerHTML="";
  summary.innerHTML="";
  finalWater.textContent="Nil";
  finalPantry.textContent="Nil";
  saveAll();
}

function clearStorage() {
    if(confirm("Tüm veriler silinecek, emin misiniz?")) {
        localStorage.removeItem("hlc_data");
        location.reload();
    }
}

function updateMix(){
  mxAvg.value=((+byAvg.value||0)+(+bcAvg.value||0))/2;
  updateSummary();
  saveAll();
}

function checkLoadType(){
 const ac=aircraft.value, lt=loadType.value;
 if(!lt){fullReset(); return;}
 if((ac==="B737"&&lt==="ULD")||(wide.includes(ac)&&lt==="YIGMA")){
  alert("Seçim geçersiz!"); loadType.value=""; fullReset(); return;}
 updateCompartments(true);
}

function updateCompartments(r){
 if(r) compartments.innerHTML="";
 if(!aircraft.value || !loadType.value) return;
 comps[aircraft.value].forEach(n=>{
  const c=document.createElement("div");
  c.className="compartment";
  c.dataset.num = n;
  c.innerHTML=`<h3 onclick="toggleContent(this)">
  CPT ${n}<span class="weight-display">0 kg</span></h3><div class="content"></div>`;
  const ct=c.querySelector(".content");

  if(loadType.value==="YIGMA"||n===5){
    ct.innerHTML+=`<div class="bagaj flex">
      By <input type="number" class="by" oninput="updateSummary();saveAll()">
      Bc <input type="number" class="bc" oninput="updateSummary();saveAll()">
      Mix <input type="number" class="mx" oninput="updateSummary();saveAll()">
    </div>`;
  }

  if(loadType.value==="ULD" && n!==5){
    const lbl=wide.includes(aircraft.value)?"AKE":"AKH";
    ct.innerHTML+=`<div class="konteyner flex">${lbl} Bagaj
      <select class="bagType"><option>By</option><option>Bc</option><option>Mix</option></select>
      <button onclick="addBagaj(this)">+</button>
    </div>`;
  }

  ct.innerHTML+=`<div class="kargo flex">Cargo <button onclick="addItem(this,'Cargo')">+</button></div>
  <div class="ek flex">Manuel <button onclick="addItem(this,'Manuel')">+</button></div>`;
  compartments.appendChild(c);
 });
 updateSummary();
}

function toggleContent(el) {
    const content = el.nextElementSibling;
    content.style.display = content.style.display === 'none' ? 'block' : 'none';
}

function addBagaj(b, savedVal = null){
 const t=b.previousElementSibling.value, p=b.parentElement;
 const d=createItemWrapper(t, "konteyner-item", savedVal, () => renumberGlobalBag(t));
 p.appendChild(d);
 renumberGlobalBag(t); updateSummary(); saveAll();
}

function addItem(b, k, savedVal = null){
 const p=b.parentElement;
 const d=createItemWrapper(k, "item-wrapper", savedVal, () => renumber(p.closest('.content'), k));
 p.appendChild(d);
 renumber(p.closest('.content'), k); updateSummary(); saveAll();
}

function createItemWrapper(label, className, val, renumFn) {
 const d=document.createElement("div");
 d.className=className + " item-wrapper";
 d.dataset.type = label; d.dataset.kind = label;
 d.innerHTML = `<span>${label}</span>
    <input type="number" class="item-input" value="${val||''}" oninput="updateSummary();saveAll()">
    <button onclick="this.parentElement.remove(); ${renumFn.name.includes('Global') ? `renumberGlobalBag('${label}')` : `renumber(this.closest('.content'),'${label}')`}; updateSummary(); saveAll()">Sil</button>`;
 return d;
}

function renumber(container, kind){
  if(!container) return;
  let i=1;
  container.querySelectorAll(`.item-wrapper[data-kind="${kind}"]`).forEach(e=>{
    e.querySelector('span').textContent = kind+" "+(i++);
  });
}

function renumberGlobalBag(type){
 let i=1;
 document.querySelectorAll('.konteyner-item[data-type="'+type+'"]').forEach(e=>{
   e.querySelector('span').textContent = type+" "+(i++);
 });
}

function updateCPTBadge(){
 document.querySelectorAll('.compartment').forEach(c=>{
  const ltVal=loadType.value;
  let B=0, C=0, M=0;
  const cNum = parseInt(c.dataset.num);

  if(ltVal==='YIGMA' || cNum===5){
    c.querySelectorAll('.bagaj input').forEach(i=>B+=+i.value||0);
    c.querySelectorAll('.item-wrapper[data-kind="Cargo"]').forEach(i=>C+=+i.querySelector('input').value||0);
    c.querySelectorAll('.item-wrapper[data-kind="Manuel"]').forEach(i=>M+=+i.querySelector('input').value||0);
  } else {
    B=c.querySelectorAll('.konteyner-item').length;
    C=c.querySelectorAll('.item-wrapper[data-kind="Cargo"]').length;
    M=c.querySelectorAll('.item-wrapper[data-kind="Manuel"]').length;
  }

  const h=c.querySelector('h3');
  let mid=h.querySelector('.midBadge') || document.createElement('span');
  mid.className='midBadge'; h.insertBefore(mid, h.querySelector('.weight-display'));
  let out=[];
  if(B) out.push("B "+B); if(C) out.push("C "+C); if(M) out.push("Mn "+M);
  mid.textContent=out.join(" / ");
 });
}

function updateSummary(){
 let out="";
 const byA=+byAvg.value||0, bcA=+bcAvg.value||0, mxA=+mxAvg.value||0;
 document.querySelectorAll(".compartment").forEach(c=>{
   let t=0;
   c.querySelectorAll(".bagaj").forEach(b=>{
     t+=(+b.querySelector(".by").value||0)*byA + (+b.querySelector(".bc").value||0)*bcA + (+b.querySelector(".mx").value||0)*mxA;
   });
   c.querySelectorAll(".konteyner-item").forEach(k=>{
     const v=+k.querySelector("input").value||0;
     const avg=k.dataset.type==="By"?byA:k.dataset.type==="Bc"?bcA:mxA;
     t+=(v*avg+70)-v;
   });
   c.querySelectorAll('.item-wrapper:not(.konteyner-item)').forEach(i=>t+=+i.querySelector("input").value||0);
   c.querySelector(".weight-display").textContent=Math.round(t)+" kg";
   out+=`<div>CPT ${c.dataset.num}: ${Math.round(t)} kg</div>`;
 });
 summary.innerHTML=out;
 finalWater.textContent=waterInput.value||"Nil";
 finalPantry.textContent=pantryInput.value||"Nil";
 updateCPTBadge();
}

function saveAll(){
  const data = {
    ac: aircraft.value, lt: loadType.value,
    w: waterInput.value, p: pantryInput.value,
    by: byAvg.value, bc: bcAvg.value, n: note.value,
    comps: []
  };

  document.querySelectorAll('.compartment').forEach(c => {
    let cObj = { num: c.dataset.num, yigma: [], items: [] };
    c.querySelectorAll('.bagaj input').forEach(i => cObj.yigma.push(i.value));
    c.querySelectorAll('.item-wrapper').forEach(iw => {
      cObj.items.push({
        k: iw.dataset.kind || iw.dataset.type,
        v: iw.querySelector('input').value,
        isK: iw.classList.contains('konteyner-item')
      });
    });
    data.comps.push(cObj);
  });
  localStorage.setItem("hlc_data", JSON.stringify(data));
}

function loadAll(){
  const raw = localStorage.getItem("hlc_data");
  if(!raw) return;
  const data = JSON.parse(raw);

  aircraft.value = data.ac;
  loadType.value = data.lt;
  if(!data.ac || !data.lt) return;

  updateCompartments(true);

  waterInput.value = data.w;
  pantryInput.value = data.p;
  byAvg.value = data.by;
  bcAvg.value = data.bc;
  mxAvg.value = ((+data.by||0)+(+data.bc||0))/2;
  note.value = data.n;

  const domComps = document.querySelectorAll('.compartment');
  data.comps.forEach((cData, idx) => {
    const dc = domComps[idx];
    if(!dc) return;
    const yInputs = dc.querySelectorAll('.bagaj input');
    cData.yigma.forEach((val, i) => { if(yInputs[i]) yInputs[i].value = val; });
    cData.items.forEach(item => {
      if(item.isK) {
        const btn = dc.querySelector('.konteyner button');
        dc.querySelector('.bagType').value = item.k;
        addBagaj(btn, item.v);
      } else {
        const targetBtn = item.k === 'Cargo' ? dc.querySelector('.kargo button') : dc.querySelector('.ek button');
        addItem(targetBtn, item.k, item.v);
      }
    });
  });
  updateSummary();
}

window.onload = loadAll;
</script>
</body>
</html>
