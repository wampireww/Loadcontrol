<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Harekat Load Control - Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<style>
html, body { overscroll-behavior-y: contain; height: 100%; overflow-x: hidden; }
body{font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background:#f0f2f5; margin:8px; padding-bottom:120px; color: #333;}

section{background:#fff; border-radius:10px; padding:12px; margin-bottom:10px; box-shadow: 0 1px 4px rgba(0,0,0,0.15);}
h1{text-align:center; color:#004080; margin:10px 0; font-size:1.4em; font-weight: bold;}
h3{cursor:pointer; margin:4px 0; font-size: 1.05em; display:flex; justify-content:space-between; align-items:center; color: #004080; font-weight: 600;}

.flex{display:flex; flex-wrap:wrap; align-items:center; gap:10px;}
select, input[type=number], input[type=text]{ 
    padding: 10px; border: 1px solid #bbb; border-radius: 8px; font-size: 15px; outline: none; color: #000;
}
select{ background: #fff; flex: 1; min-width: 90px;}
input[type=number]{ width: 75px; font-weight: 500;}

button{ background:#004080; color:#fff; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; font-weight: 600; -webkit-tap-highlight-color: transparent;}
button:active{ background:#002b57; transform: scale(0.96); }

.compartment{ border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px; }
.content{ display:none; background:#f9f9f9; padding:10px; border-radius:8px; border: 1px solid #e0e0e0; margin-top: 8px;}

.items-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }

.item-wrapper {
    display: flex; align-items: center; background: #fff; padding: 6px 10px; border-radius: 8px; 
    border: 1px solid #004080; font-size: 0.9em; white-space: nowrap; font-weight: 600; color: #000;
}
.item-input { width: 60px !important; margin: 0 8px; padding: 6px !important; border: 1px solid #004080 !important; color: #000 !important; font-weight: bold;}

.delete-btn { background: #e60000; padding: 5px 10px; font-size: 0.85em; margin-left: 5px; border-radius: 6px;}

.summary{ background:#004080; color: white; padding:15px; border-radius: 15px;}
.summary h3 { color: white; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 8px; margin-bottom: 10px;}
.weight-display { font-size: 0.95em; color: #fff; background: #0066cc; padding: 4px 8px; border-radius: 6px; }
.midBadge { font-size: 0.8em; color: #555; font-weight: 600; margin-right: auto; margin-left: 12px;}

/* NOT EKLE KISMI DÜZENLEMESİ */
#note { 
    width: 100%; 
    height: 100px; 
    margin-top: 15px; 
    border-radius: 10px; 
    padding: 12px; 
    border: 2px solid #004080; 
    box-sizing: border-box; 
    font-family: inherit; 
    font-size: 16px; /* Yazı boyutu büyüdü */
    color: #000000;  /* Yazı rengi tam siyah yapıldı */
    font-weight: 500;
    background-color: #ffffff;
}
#note::placeholder { color: #888; font-weight: normal; }

.final-row { display: flex; justify-content: space-between; margin-top: 12px; font-size: 1em; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 10px; font-weight: bold;}
</style>
</head>
<body>

<h1>Harekat Load Control</h1>

<section class="flex">
    <div style="flex:1">Uçak: 
        <select id="aircraft" onchange="fullReset();checkLoadType()">
            <option value="">Seç</option>
            <option>A319</option><option>A320</option><option>A321</option><option>B737</option>
            <option>A330</option><option>A350</option><option>B777</option><option>B787</option>
        </select>
    </div>
    <div style="flex:1">Yükleme: 
        <select id="loadType" onchange="checkLoadType()">
            <option value="">Seç</option>
            <option value="YIGMA">Yığma</option>
            <option value="ULD">ULD</option>
        </select>
    </div>
</section>

<section class="flex">
    Water <input type="number" id="waterInput" oninput="saveAll();updateSummary()">
    Pantry <input type="number" id="pantryInput" oninput="saveAll();updateSummary()">
</section>

<section>
    <h3 style="margin-bottom:10px">Bagaj Ortalamaları</h3>
    <div class="flex">
        By <input type="number" id="byAvg" value="13" oninput="updateMix()">
        Bc <input type="number" id="bcAvg" value="11" oninput="updateMix()">
        Mix <input type="number" id="mxAvg" readonly>
    </div>
</section>

<section id="compartments"></section>

<section class="summary">
    <h3>Final Kontrol</h3>
    <div id="summary" style="font-size: 1em; line-height: 1.8;"></div>
    <div class="final-row">
        <span>Water: <span id="finalWater">0</span></span>
        <span>Pantry: <span id="finalPantry">0</span></span>
    </div>
    
    <textarea id="note" placeholder="Operasyonel notlarınızı buraya yazın..." oninput="saveAll()"></textarea>

    <div class="flex" style="justify-content: space-between; margin-top: 15px;">
        <button onclick="saveAll()" style="background: #2ecc71; flex:1; margin-right:8px; font-size: 1.1em;">Kaydet</button>
        <button onclick="clearStorage()" style="background:#e74c3c; flex:1; font-size: 1.1em;">Sıfırla</button>
    </div>
</section>

<script>
const comps={A319:[1,4,5],A320:[1,3,4,5],A321:[1,2,3,4,5],B737:[1,2,3,4],
A330:[1,2,3,4,5],A350:[1,2,3,4,5],B777:[1,2,3,4,5],B787:[1,2,3,4,5]};
const wide=["A330","A350","B777","B787"];

function fullReset(){
  document.getElementById('compartments').innerHTML="";
  document.getElementById('summary').innerHTML="";
  saveAll();
}

function clearStorage() {
    if(confirm("DİKKAT: Tüm veriler temizlenecektir. Emin misiniz?")) {
        localStorage.removeItem("hlc_data");
        location.reload();
    }
}

function updateMix(){
  const by = +document.getElementById('byAvg').value||0;
  const bc = +document.getElementById('bcAvg').value||0;
  document.getElementById('mxAvg').value = (by + bc) > 0 ? (by + bc) / 2 : "";
  updateSummary();
  saveAll();
}

function checkLoadType(){
 const ac=document.getElementById('aircraft').value, lt=document.getElementById('loadType').value;
 if(!lt){fullReset(); return;}
 if((ac==="B737"&&lt==="ULD")||(wide.includes(ac)&&lt==="YIGMA")){
  alert("Uçak ve yükleme tipi uyumsuz!"); document.getElementById('loadType').value=""; fullReset(); return;}
 updateCompartments(true);
}

function updateCompartments(r){
 const container = document.getElementById('compartments');
 if(r) container.innerHTML="";
 if(!document.getElementById('aircraft').value || !document.getElementById('loadType').value) return;
 
 comps[document.getElementById('aircraft').value].forEach(n=>{
  const c=document.createElement("div");
  c.className="compartment";
  c.dataset.num = n;
  c.innerHTML=`<h3 onclick="toggleContent(this)">
  CPT ${n} <span class="midBadge"></span> <span class="weight-display">0 kg</span></h3>
  <div class="content">
    <div class="inner-items"></div>
  </div>`;
  const ct = c.querySelector(".content");
  const inner = ct.querySelector(".inner-items");

  if(document.getElementById('loadType').value==="YIGMA" || n===5){
    inner.innerHTML+=`<div style="margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:10px;" class="flex">
      <div style="font-size:0.8em">By <input type="number" class="by" oninput="updateSummary();saveAll()"></div>
      <div style="font-size:0.8em">Bc <input type="number" class="bc" oninput="updateSummary();saveAll()"></div>
      <div style="font-size:0.8em">Mx <input type="number" class="mx" oninput="updateSummary();saveAll()"></div>
    </div>`;
  }

  if(document.getElementById('loadType').value==="ULD" && n!==5){
    const lbl=wide.includes(document.getElementById('aircraft').value)?"AKE":"AKH";
    inner.innerHTML+=`<div style="margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:10px;">
      <div class="flex"><strong>${lbl}</strong>
      <select class="bagType"><option>By</option><option>Bc</option><option>Mix</option></select>
      <button onclick="addBagaj(this)">+</button></div>
      <div class="items-container"></div>
    </div>`;
  }

  inner.innerHTML+=`<div style="margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:10px;">
    Cargo <button onclick="addItem(this,'Cargo')">+</button>
    <div class="items-container"></div></div>
  <div>Manuel <button onclick="addItem(this,'Manuel')">+</button>
    <div class="items-container"></div></div>`;
  
  container.appendChild(c);
 });
 updateSummary();
}

function toggleContent(el) {
    const content = el.nextElementSibling;
    content.style.display = (content.style.display === 'block') ? 'none' : 'block';
}

function renumberGlobalBag(type){
 let i=1;
 document.querySelectorAll(`.konteyner-item[data-type="${type}"]`).forEach(e=>{
   e.querySelector('span').textContent = type + " " + (i++);
 });
}

function renumberLocal(container, kind){
  let i=1;
  container.querySelectorAll(`.local-item[data-kind="${kind}"]`).forEach(e=>{
    e.querySelector('span').textContent = kind + " " + (i++);
  });
}

function addBagaj(b, savedVal = null){
 const t=b.previousElementSibling.value, holder=b.parentElement.nextElementSibling;
 const d=document.createElement("div");
 d.className="konteyner-item item-wrapper";
 d.dataset.type = t; d.dataset.kind = t;
 d.innerHTML = `<span>${t}</span>
    <input type="number" class="item-input" value="${savedVal||''}" oninput="updateSummary();saveAll()">
    <button class="delete-btn" onclick="this.parentElement.remove(); renumberGlobalBag('${t}'); updateSummary(); saveAll()">X</button>`;
 holder.appendChild(d);
 renumberGlobalBag(t); updateSummary(); saveAll();
}

function addItem(b, k, savedVal = null){
 const holder=b.nextElementSibling;
 const d=document.createElement("div");
 d.className="local-item item-wrapper";
 d.dataset.kind = k;
 d.innerHTML = `<span>${k}</span>
    <input type="number" class="item-input" value="${savedVal||''}" oninput="updateSummary();saveAll()">
    <button class="delete-btn" onclick="const h=this.parentElement.parentElement; this.parentElement.remove(); renumberLocal(h,'${k}'); updateSummary(); saveAll()">X</button>`;
 holder.appendChild(d);
 renumberLocal(holder, k); updateSummary(); saveAll();
}

function updateSummary(){
 let out="";
 const byA=+document.getElementById('byAvg').value||0;
 const bcA=+document.getElementById('bcAvg').value||0;
 const mxA=+document.getElementById('mxAvg').value||0;

 document.querySelectorAll(".compartment").forEach(c=>{
   let t=0;
   c.querySelectorAll(".by").forEach(i=>t+=(+i.value||0)*byA);
   c.querySelectorAll(".bc").forEach(i=>t+=(+i.value||0)*bcA);
   c.querySelectorAll(".mx").forEach(i=>t+=(+i.value||0)*mxA);
   
   c.querySelectorAll(".konteyner-item").forEach(k=>{
     const v=+k.querySelector("input").value||0;
     const avg=(k.dataset.type==="By")?byA:(k.dataset.type==="Bc")?bcA:mxA;
     t+=(v*avg+70)-v;
   });
   c.querySelectorAll('.local-item').forEach(i=>t+=+i.querySelector("input").value||0);
   
   c.querySelector(".weight-display").textContent=Math.round(t)+" kg";
   out+=`<div>CPT ${c.dataset.num}: <strong>${Math.round(t)} kg</strong></div>`;
 });
 
 document.getElementById('summary').innerHTML=out;
 document.getElementById('finalWater').textContent=document.getElementById('waterInput').value||"0";
 document.getElementById('finalPantry').textContent=document.getElementById('pantryInput').value||"0";
 updateCPTBadge();
}

function updateCPTBadge(){
 document.querySelectorAll('.compartment').forEach(c=>{
  const ltVal=document.getElementById('loadType').value;
  let B=0, C=0, M=0;
  const cNum = parseInt(c.dataset.num);
  if(ltVal==='YIGMA' || cNum===5){
    c.querySelectorAll('.by, .bc, .mx').forEach(i=>B+=+i.value||0);
  } else {
    B=c.querySelectorAll('.konteyner-item').length;
  }
  C=c.querySelectorAll('.local-item[data-kind="Cargo"]').length;
  M=c.querySelectorAll('.local-item[data-kind="Manuel"]').length;
  const mid=c.querySelector('.midBadge');
  let out=[];
  if(B) out.push("B "+B); if(C) out.push("C "+C); if(M) out.push("Mn "+M);
  mid.textContent=out.join(" / ");
 });
}

function saveAll(){
  const data = {
    ac: document.getElementById('aircraft').value,
    lt: document.getElementById('loadType').value,
    w: document.getElementById('waterInput').value,
    p: document.getElementById('pantryInput').value,
    by: document.getElementById('byAvg').value,
    bc: document.getElementById('bcAvg').value,
    n: document.getElementById('note').value,
    comps: []
  };
  document.querySelectorAll('.compartment').forEach(c => {
    let cObj = { num: c.dataset.num, yigma: [], items: [] };
    c.querySelectorAll('.by, .bc, .mx').forEach(i => cObj.yigma.push(i.value));
    c.querySelectorAll('.item-wrapper').forEach(iw => {
      cObj.items.push({
        k: iw.dataset.kind || iw.dataset.type,
        v: iw.querySelector('input').value,
        isK: iw.classList.contains('konteyner-item')
      });
    });
    data.comps.push(cObj);
  });
  localStorage.setItem("hlc_data", JSON.stringify(data));
}

function loadAll(){
  const raw = localStorage.getItem("hlc_data");
  if(!raw) return;
  const data = JSON.parse(raw);
  document.getElementById('aircraft').value = data.ac;
  document.getElementById('loadType').value = data.lt;
  if(!data.ac || !data.lt) return;
  updateCompartments(true);
  document.getElementById('waterInput').value = data.w;
  document.getElementById('pantryInput').value = data.p;
  document.getElementById('byAvg').value = data.by;
  document.getElementById('bcAvg').value = data.bc;
  document.getElementById('mxAvg').value = ((+data.by||0)+(+data.bc||0))/2;
  document.getElementById('note').value = data.n;
  const domComps = document.querySelectorAll('.compartment');
  data.comps.forEach((cData, idx) => {
    const dc = domComps[idx]; if(!dc) return;
    const yInputs = dc.querySelectorAll('.by, .bc, .mx');
    cData.yigma.forEach((val, i) => { if(yInputs[i]) yInputs[i].value = val; });
    cData.items.forEach(item => {
      if(item.isK) {
        dc.querySelector('.bagType').value = item.k;
        addBagaj(dc.querySelector('.inner-items button'), item.v);
      } else {
        const targetBtn = item.k === 'Cargo' ? dc.querySelectorAll('.inner-items button')[1] : dc.querySelectorAll('.inner-items button')[2];
        // Not: ULD/Yigma farkına göre buton indexi değişebilir, bu yüzden tip kontrolü ile eklenir
        addItem(targetBtn, item.k, item.v);
      }
    });
  });
  updateSummary();
}
window.onload = loadAll;
</script>
</body>
</html>
